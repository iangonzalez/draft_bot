# Draft bot

Code to train and run a neural net that can recommend picks in a Magic: the Gathering
draft.

The deep learning methodology used for the model here is based in part on the paper at
https://arxiv.org/pdf/2009.00655.pdf (Ward et al).

## Quickstart

Make sure you have the python packages `torch`, `numpy`, and `pandas` installed.

1. Download draft data at https://www.17lands.com/public_datasets.
1. `cd draft_bot/src` and `data_processing/vectorize_data.py <input csv> <output dir>`
    to generate a vectorized, split dataset for training.
1. `train_nnet.py -d <data dir> -o <output dir> -s <set id>` to train a model.
1. `eval_nnet.py -d <data dir> -m <model path> -s <set id>` to test a particular model.
1. `run_bot.py -l <log dir> -m <model path> -s <set id>` to run the bot on MTGA
    logs using a particular model.

See below for more detailed explanations.

### Colab

If you would prefer to get started with a notebook where you can examine the 
data, feel free to use the .ipynb under `colab/`.

## Data directory

The code generally expects that you will store your data under the `data/<set id>`
directory, where `<set id>` is the MtG set being analyzed (e.g. `BRO` for the
Brothers' War). At time of writing, only BRO data was used for this project;
more set data might be added / trained on in the future.

### Included data

- `data/<set id>/set_config.json`: A json object that consolidates multiple useful
   params for a set. Will be read by the scripts under `src/`. Update with
   paths to your trained model and (optionally) card images.
- `data/<set id>/per_card_data/arena_ids_to_names.json`: A mapping from arena id
  (integer used to represent cards in MTGA) to card name (data from Scryfall API).
- `data/<set id>/per_card_data/<set id>_canonical_card_list.json`: An
  alphabetized list of the draftable cards in the set. This is "canonical"
  because all the code will assume this ordering for vectorization purposes
  (i.e. card #0 for BRO will always mean Adaptive Automaton).

### Excluded data

The data and models are not included in this repo; if you are planning on
replicating this work, I recommend using the public 17lands data sets at
https://www.17lands.com/public_datasets.

I personally used `data/<set id>/raw/` for the raw .csv and 
`data/<set id>/processed/` for the vectorized post-processed data. I placed
trained models at `data/<set id>/models`.

## Source directory

### data_processing

Code to vectorize a 17lands data set. 

The output will be a set of saved tensor
files -- each will have a number of rows corresponding to a parameter set in
the code. Note that these "splits" of the data will be used to create training
and test sets.

Each set of cards (pool, pack, pick) is represented by an N-hot encoding
vector. For example, a pool with 1 Adaptive Automaton will have a 1.0 in the
0th index of the vector, and so on (indices determined by the canonical order
described in the data section above).

### training

Code to represent the model and load data.

`draft_pick_nnet.py` is the model representation. This is based on the paper
above -- 3 fully connected linear + norm + dropout + relu layers, followed by
a final linear layer. The "in pack" constraint is applied at the end.

`draft_dataset_splitter.py` splits a set of tensors generated by the data
processing step into training and test sets.

The top-level scripts `train_nnet` and `eval_nnet` can be used for training and
testing, respectively. Note that models trained by `train_nnet` will be
uniquely identified by including the datetime of training in the filename.

### arena_draft_bot

Code to run the model on actual draft data, including an implementation for
MTGA logs.

`draft_manager.py` and `pick_display_utils.py` are general-purpose tools for
running the model against a draft and displaying the model's picks.

`arena_draft_manager.py` and `arena_draft_bot.py` use these tools to predict on
a MTGA draft by parsing log lines that the app produces. See
https://mtgarena-support.wizards.com/hc/en-us/articles/360000726823-Creating-Log-Files-on-PC-Mac
for information on how to find these logs.

`run_bot.py` is the top-level script for running the arena draft bot.

The model can be run in more contexts by overriding the `DraftManager` class.
More implementations may be added in the future (for example, running the model
against your own 17lands draft data).


# Legal / Policy notes

## Fan Content note

The WoTC Fan Content policy can be found here: https://company.wizards.com/en/legal/fancontentpolicy

This draft bot is unofficial Fan Content permitted under the Fan Content Policy. Not
approved/endorsed by Wizards. Portions of the materials used are property of
Wizards of the Coast. Â©Wizards of the Coast LLC.

## Contributing

See [`CONTRIBUTING.md`](CONTRIBUTING.md) for details.

## License

Apache 2.0; see [`LICENSE`](LICENSE) for details.

## Disclaimer

This project is not an official Google project. It is not supported by
Google and Google specifically disclaims all warranties as to its quality,
merchantability, or fitness for a particular purpose.
